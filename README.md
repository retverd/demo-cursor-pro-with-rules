# Demo: Cursor Pro with rules

Демонстрация генерации кода через Cursor Pro с применением правил

## Описание проекта

Проект содержит два независимых модуля для сбора финансовых данных:

### 1. Модуль котировок LQDT (`src/quotes/fetch_lqdt.py`)

Загружает дневные свечи и средневзвешенную цену (VWAP) инструмента LQDT с Московской биржи через API и сохраняет данные в XLSX-файл.

**Возможности:**

- Загрузка исторических данных за указанный период (в годах)
- Получение дневных свечей (OHLCV)
- Расчёт и включение VWAP (средневзвешенной цены)
- Автоматическая генерация имени файла с датами периода и временем создания
- Гибкая настройка через аргументы командной строки

**Пример использования:**

```bash
# Загрузка данных за последние 2 года (по умолчанию)
python -m src.quotes.fetch_lqdt

# Загрузка данных за последние 3 года
python -m src.quotes.fetch_lqdt --years 3

# Загрузка данных с указанием конечной даты
python -m src.quotes.fetch_lqdt --years 1 --end-date 2024-12-31

# Сохранение в указанный файл
python -m src.quotes.fetch_lqdt --output my_data.xlsx
```

### 2. Модуль курсов валют (`src/rates/fetch_usd_rub.py`)

Загружает курсы EUR/RUB с сайта Центрального банка РФ и сохраняет данные в Parquet-файл с метаданными.

**Возможности:**

- Загрузка курсов за указанный период (в днях)
- Парсинг XML-ответа от API ЦБ РФ
- Нормализация курсов с учётом номинала
- Сохранение в формате Parquet с метаданными (дата отчёта, период)
- Использование типа `Decimal` для точного хранения курсов

**Пример использования:**

```bash
# Загрузка курсов за последние 7 дней (по умолчанию)
python -m src.rates.fetch_usd_rub

# Загрузка курсов за последние 30 дней
python -m src.rates.fetch_usd_rub --days 30

# Загрузка курсов с указанием конечной даты
python -m src.rates.fetch_usd_rub --days 14 --end-date 2024-12-31

# Сохранение в указанный файл
python -m src.rates.fetch_usd_rub --output rates.parquet
```

## Технологический стек

- **Python 3.14** — целевая версия языка
- **pandas** — обработка данных и работа с Excel
- **pyarrow** — работа с форматом Parquet
- **apimoex** — клиент для API Московской биржи
- **requests** — HTTP-запросы
- **openpyxl** — работа с XLSX-файлами
- **pytest** — фреймворк для тестирования

## Настройка окружения

### Требования

- Python 3.14 или выше
- pip (менеджер пакетов Python)

### Установка зависимостей

1. **Клонируйте репозиторий** (если проект находится в Git):

   ```bash
   git clone <repository-url>
   cd demo-cursor-pro-with-rules
   ```

2. **Создайте виртуальное окружение** (рекомендуется):

   ```bash
   # Windows (PowerShell)
   python -m venv venv
   .\venv\Scripts\Activate.ps1

   # Linux/macOS
   python -m venv venv
   source venv/bin/activate
   ```

3. **Установите зависимости**:

   ```bash
   pip install -r requirements.txt
   ```

   Если файл `requirements.txt` отсутствует, установите зависимости вручную:

   ```bash
   pip install apimoex pandas pyarrow requests openpyxl pytest
   ```

### Структура проекта

```text
demo-cursor-pro-with-rules/
├── src/
│   ├── quotes/          # Модуль котировок LQDT
│   │   ├── __init__.py
│   │   └── fetch_lqdt.py
│   └── rates/           # Модуль курсов валют
│       ├── __init__.py
│       └── fetch_usd_rub.py
├── tests/               # Тесты
│   ├── test_fetch_lqdt.py
│   └── test_fetch_usd_rub.py
├── pytest.ini           # Конфигурация pytest
├── requirements.txt     # Зависимости проекта
└── README.md           # Этот файл
```

## Решение проблем (Troubleshooting)

### Проблемы с версией Python

**Проблема:** Ошибка `SyntaxError` или сообщение о несовместимости версий.

**Решение:**

- Убедитесь, что установлена Python 3.14 или выше:

  ```bash
  python --version
  ```

- Если версия устарела, обновите Python до 3.14+ или используйте `pyenv` для управления версиями:

  ```bash
  # Linux/macOS
  pyenv install 3.14
  pyenv local 3.14
  ```

### Проблемы с установкой зависимостей

**Проблема:** Ошибки при установке пакетов через `pip install`.

**Решение:**

- Обновите `pip` до последней версии:

  ```bash
  python -m pip install --upgrade pip
  ```

- Убедитесь, что виртуальное окружение активировано

- Для некоторых пакетов (например, `pyarrow`) могут потребоваться системные библиотеки. На Linux установите:

  ```bash
  sudo apt-get install build-essential
  ```

### Проблемы с виртуальным окружением

**Проблема:** Модули не находятся при запуске скриптов.

**Решение:**

- Убедитесь, что виртуальное окружение активировано (в командной строке должен быть префикс `(venv)`)
- Переустановите зависимости:

  ```bash
  pip install -r requirements.txt --force-reinstall
  ```

### Проблемы с подключением к API

**Проблема:** `QuoteFetchError` или `RateFetchError` при загрузке данных.

**Решение:**

- **Для МосБиржи:**
  - Проверьте подключение к интернету
  - API МосБиржи может быть временно недоступен, попробуйте позже
  - Убедитесь, что указанные даты корректны (не в будущем, не слишком старые)

- **Для ЦБ РФ:**
  - Проверьте подключение к интернету
  - API ЦБ РФ может иметь ограничения по частоте запросов
  - Убедитесь, что указанный период не слишком большой (рекомендуется не более 365 дней за запрос)

- Проверьте доступность API вручную:

  ```bash
  # Для МосБиржи
  curl https://iss.moex.com/iss/engines/stock/markets/shares/securities.json

  # Для ЦБ РФ
  curl "https://www.cbr.ru/scripts/XML_dynamic.asp?date_req1=01/01/2024&date_req2=01/01/2024&VAL_NM_RQ=R01239"
  ```

### Проблемы с форматами дат

**Проблема:** Ошибка `ValueError` при указании даты в неправильном формате.

**Решение:**

- Используйте формат ISO: `YYYY-MM-DD` (например, `2024-12-31`)
- Убедитесь, что дата корректна:

  ```bash
  # Правильно
  python -m src.quotes.fetch_lqdt --end-date 2024-12-31

  # Неправильно
  python -m src.quotes.fetch_lqdt --end-date 31-12-2024
  ```

### Проблемы с правами доступа при создании файлов

**Проблема:** Ошибка `PermissionError` при сохранении файлов.

**Решение:**

- Убедитесь, что у вас есть права на запись в целевую директорию
- На Linux/macOS проверьте права доступа:

  ```bash
  ls -la <путь_к_директории>
  chmod 755 <путь_к_директории>
  ```

- Укажите путь к файлу в директории, где у вас есть права на запись:

  ```bash
  python -m src.quotes.fetch_lqdt --output ~/Documents/my_data.xlsx
  ```

### Проблемы с тестами

**Проблема:** Тесты не запускаются или падают с ошибками.

**Решение:**

- Убедитесь, что все зависимости установлены, включая `pytest`:

  ```bash
  pip install -r requirements.txt
  ```

- Проверьте, что вы находитесь в корневой директории проекта

- Запустите тесты с подробным выводом для диагностики:

  ```bash
  pytest -v -s
  ```

- Если тесты падают из-за отсутствия интернета (для реальных запросов), убедитесь, что используются моки (тесты должны работать офлайн)

### Проблемы с импортами модулей

**Проблема:** `ModuleNotFoundError` при запуске скриптов или тестов.

**Решение:**

- Убедитесь, что вы запускаете скрипты из корневой директории проекта
- Проверьте, что директория проекта добавлена в `PYTHONPATH` или используйте запуск через модуль:

  ```bash
  # Правильно
  python -m src.quotes.fetch_lqdt

  # Неправильно
  python src/quotes/fetch_lqdt.py
  ```
  
- Убедитесь, что структура директорий соответствует ожидаемой (директория `src/` существует)

### Пустой результат от API

**Проблема:** API возвращает пустой набор данных без ошибок.

**Решение:**

- Проверьте, что указанный период содержит рабочие дни (выходные и праздники могут отсутствовать)
- Для МосБиржи: убедитесь, что инструмент LQDT торговался в указанный период
- Для ЦБ РФ: курсы валют публикуются только в рабочие дни
- Попробуйте расширить диапазон дат или выбрать другой период

### Дополнительная помощь

Если проблема не решена:

1. Проверьте логи ошибок полностью — они часто содержат полезную информацию
2. Убедитесь, что вы используете последнюю версию кода из репозитория
3. Проверьте, что все зависимости соответствуют версиям в `requirements.txt`

## Запуск тестов

Проект использует `pytest` для тестирования. Все тесты находятся в директории `tests/`.

### Запуск всех тестов

```bash
pytest
```

### Запуск тестов с подробным выводом

```bash
pytest -v
```

### Запуск тестов для конкретного модуля

```bash
# Тесты для модуля котировок LQDT
pytest tests/test_fetch_lqdt.py

# Тесты для модуля курсов валют
pytest tests/test_fetch_usd_rub.py
```

### Запуск тестов с покрытием кода

Для анализа покрытия кода тестами установите `pytest-cov`:

```bash
pip install pytest-cov
```

Затем запустите тесты с отчётом о покрытии:

```bash
pytest --cov=src --cov-report=html
```

Отчёт будет сохранён в директории `htmlcov/`.

### Конфигурация pytest

Настройки pytest указаны в файле `pytest.ini`:

- `pythonpath = .` — добавляет корневую директорию проекта в путь поиска модулей
- `testpaths = tests` — указывает директорию с тестами

## Особенности реализации

- **Типизация**: Все функции и методы имеют аннотации типов
- **Документация**: Все функции содержат docstrings на русском языке
- **Обработка ошибок**: Специализированные исключения для каждого модуля (`QuoteFetchError`, `RateFetchError`)
- **Современный Python**: Используются возможности Python 3.14, включая `pathlib`, современные типы и `from __future__ import annotations`
- **Тестирование**: Полное покрытие тестами с использованием моков для HTTP-запросов

## Разработка

### Стандарты кода

Проект следует следующим правилам:

- Все docstrings и комментарии на русском языке
- Использование `pathlib` вместо `os.path`
- Использование современных типов из модуля `typing`
- Форматирование кода через `ruff`/`black`
- Использование `argparse` для CLI

### Добавление новых модулей

При добавлении нового модуля:

1. Создайте файл в соответствующей директории `src/`
2. Добавьте docstring с описанием модуля
3. Добавьте типизацию для всех функций
4. Создайте тесты в директории `tests/`
5. Обновите `requirements.txt` при необходимости

## Лицензия

Проект создан в демонстрационных целях.
